name: Test Ruleset

on:
  workflow_dispatch:

jobs:
  apply_branch_ruleset:
    runs-on: ubuntu-latest
    steps:
      - name: Apply ruleset to main branch
        env:
          GH_TOKEN: ${{ secrets.MY_PAT }}
          REPO_OWNER: Adityasjoshi123
          REPO_NAME: test-repo
        run: |
          echo "Applying ruleset to $REPO_OWNER/$REPO_NAME"

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/rulesets \
            -d '{
              "name": "Protect Main",
              "target": "branch",
              "enforcement": "active",
              "conditions": {
                "ref_name": {
                  "include": ["refs/heads/main"],
                  "exclude": []
                }
              },
              "rules": [
                {
                  "type": "pull_request",
                  "parameters": {
                    "required_approving_review_count": 2,
                    "dismiss_stale_reviews_on_push": true,
                    "require_code_owner_review": false,
                    "require_last_push_approval": false,
                    "required_review_thread_resolution": true,
                    "automatic_copilot_code_review_enabled": false
                  }
                },
                {
                  "type": "non_fast_forward",
                  "parameters": {}
                },
                {
                  "type": "deletion"
                }
              ]
            }')

          BODY=$(echo "$RESPONSE" | head -n -1)
          STATUS=$(echo "$RESPONSE" | tail -n1)

          echo "---------------------------"
          echo "HTTP STATUS: $STATUS"
          echo "RESPONSE BODY:"
          echo "$BODY"
          echo "---------------------------"

          if [[ "$STATUS" != "201" ]]; then
            echo "❌ Failed to apply ruleset"
            exit 1
          else
            echo "✅ Ruleset applied successfully!"
          fi

  configure_merge_methods:
    runs-on: ubuntu-latest
    needs: apply_branch_ruleset
    steps:
      - name: Set allowed merge methods
        env:
          GH_TOKEN: ${{ secrets.ORG_ADMIN_PAT }}
          REPO_OWNER: Adityasjoshi123
          REPO_NAME: test-repo
        run: |
          curl -X PATCH \
            https://api.github.com/repos/$REPO_OWNER/$REPO_NAME \
            -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -d '{
              "allow_merge_commit": true,
              "allow_rebase_merge": true,
              "allow_squash_merge": false
            }'
